<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Endpoint Pricing Calculator — Multi-Product + Partner Quote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"></noscript>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen bg-[#f9fafb] text-[#111827] antialiased">
  <div id="app" class="min-h-screen"></div>
  <script>
    /* =======================
       STATE
    ======================= */
    const STATE = {
      items: [
        { id: cryptoRandomId(), productKey: 'rct', endpointsText: '1000', addSupport: false, pricingModel: 'endpoint' }
      ],
      activeTab: 'customer',
      copied: false,
      showBreakdown: false
    };
    /* =======================
       DATA
    ======================= */
    const TIERS_BASE5 = [
      { max: 1000, rate: 5.00 }, { max: 2000, rate: 4.50 }, { max: 3000, rate: 4.25 }, { max: 4000, rate: 4.00 }, { max: 5000, rate: 3.75 },
      { max: 6000, rate: 3.50 }, { max: 7000, rate: 3.25 }, { max: 8000, rate: 3.00 }, { max: 9000, rate: 2.75 }, { max: 10000, rate: 2.50 },
      { max: 15000, rate: 2.25 }, { max: 20000, rate: 2.00 }, { max: 25000, rate: 1.75 }, { max: 30000, rate: 1.50 }, { max: 40000, rate: 1.25 },
      { max: 50000, rate: 1.00 }, { max: 60000, rate: 0.75 }, { max: 70000, rate: 0.50 }, { max: 80000, rate: 0.40 }, { max: 90000, rate: 0.35 },
      { max: 100000, rate: 0.30 }, { max: 120000, rate: 0.25 }, { max: 140000, rate: 0.20 }, { max: 160000, rate: 0.15 }, { max: 180000, rate: 0.10 },
      { max: 200000, rate: 0.05 }, { max: Infinity, rate: 0.10 }
    ];
    const USER_TIERS_MONTHLY = [
      { max: 999, rate: 4.00 },
      { max: 4999, rate: 3.50 },
      { max: 9999, rate: 3.00 },
      { max: 24999, rate: 2.50 },
      { max: 49999, rate: 2.00 },
      { max: Infinity, rate: 1.50 }
    ];
    const PRODUCTS = {
      rct: { name: 'Right Click Tools (Core)', baseFactor: 1, platformFee: 7500, minTotal: 12500 },
      patch: { name: 'Patching', baseFactor: 1, platformFee: 7500, minTotal: 12500 },
      insights: { name: 'Insights', baseFactor: 1, platformFee: 0, minTotal: 5000 },
      priv: { name: 'Privilege Manager', baseFactor: 1, platformFee: 0, minTotal: 5000 },
      aw_cloud: { name: 'Application Workspace — Direct Cloud', baseFactor: 11/5, platformFee: 15000, minTotal: 26000 },
      aw_onprem: { name: 'Application Workspace — Direct On-Prem', baseFactor: 10/5, platformFee: 15000, minTotal: 25000 }
    };
    /* =======================
       UTILS
    ======================= */
    function cx(...a){ return a.filter(Boolean).join(' '); }
    function money(n){ return (!isFinite(n)) ? '—' : n.toLocaleString(undefined,{ style:'currency', currency:'USD' }); }
    function int(n){ n = Number(String(n).replace(/[^0-9\-]/g,'')); return isFinite(n) ? Math.max(0, Math.floor(n)) : 0; }
    function digitsOnly(text){ return String(text ?? '').replace(/[^\d]/g,''); }
    function clampFloor(r){ return Math.max(r, 0.10); }
    function tiersFor(key){
      const f = (PRODUCTS[key] || PRODUCTS.rct).baseFactor;
      return TIERS_BASE5.map(t => ({ max: t.max, rate: clampFloor(+(t.rate * f).toFixed(4)) }));
    }
    function graduatedSubtotal(units, tiers){
      let rem = Math.max(0, Math.floor(units)), from = 0, sum = 0, lines = [];
      for(const b of tiers){
        if(rem<=0) break;
        const c = Math.min(rem, b.max - from);
        const ext = c * b.rate;
        sum += ext;
        lines.push({ band: `${from+1}–${from+c}`, units: c, rate: b.rate, extended: ext });
        rem -= c; from = b.max;
      }
      return { subtotal: sum, lines };
    }
    function premiumSupportCost(add, basePlusPlat){ return add ? Math.max(basePlusPlat * 0.20, 6000) : 0; }
    function cryptoRandomId(){
      try { return crypto.randomUUID(); } catch { return 'id-'+Math.random().toString(36).slice(2); }
    }
    /* =======================
       MODEL
    ======================= */
    function computeItem(item){
      const meta = PRODUCTS[item.productKey] || PRODUCTS.rct;
      const isAW = ['aw_cloud', 'aw_onprem'].includes(item.productKey);
      const isUserMode = isAW && item.pricingModel === 'user';
      let units = int(item.endpointsText);
      let baseARR, lines, platformFeeApplied, basePlusPlatform, support, platformWaived;
      if (isUserMode) {
        units = Math.max(250, units);
        const { subtotal: monthly, lines: monthlyLines } = graduatedSubtotal(units, USER_TIERS_MONTHLY);
        baseARR = monthly * 12;
        lines = monthlyLines.map(l => ({
          band: l.band,
          units: l.units,
          rate: l.rate * 12,
          extended: l.extended * 12
        }));
        platformFeeApplied = 0;
        platformWaived = true;
        basePlusPlatform = baseARR;
        support = premiumSupportCost(false, basePlusPlatform);
      } else {
        const { subtotal, lines: endpointLines } = graduatedSubtotal(units, tiersFor(item.productKey));
        baseARR = subtotal;
        lines = endpointLines;
        platformFeeApplied = baseARR >= 30000 ? 0 : meta.platformFee;
        platformWaived = platformFeeApplied === 0;
        basePlusPlatform = Math.max(baseARR + platformFeeApplied, meta.minTotal);
        support = premiumSupportCost(!!item.addSupport, basePlusPlatform);
      }
      const totalARR = basePlusPlatform + support;
      const msrp = totalARR;
      return {
        id: item.id,
        productKey: item.productKey,
        productName: meta.name,
        endpoints: units,
        baseARR,
        platformFeeApplied,
        platformWaived,
        basePlusPlatform,
        support,
        totalARR,
        msrp,
        partnerNewPrice: msrp * 0.75,
        partnerRenPrice: msrp * 0.85,
        marginNew$: msrp * 0.25,
        marginRen$: msrp * 0.15,
        addSupport: !!item.addSupport,
        lines,
        isUserMode
      };
    }
    function model(){
      const items = STATE.items.map(computeItem);
      const totals = items.reduce((a,it)=>({
        endpoints: a.endpoints + it.endpoints,
        baseARR: a.baseARR + it.baseARR,
        platform: a.platform + it.platformFeeApplied,
        support: a.support + it.support,
        msrp: a.msrp + it.msrp,
        partnerNew: a.partnerNew + it.partnerNewPrice,
        partnerRen: a.partnerRen + it.partnerRenPrice,
        marginNew$: a.marginNew$ + it.marginNew$,
        marginRen$: a.marginRen$ + it.marginRen$
      }), { endpoints:0, baseARR:0, platform:0, support:0, msrp:0, partnerNew:0, partnerRen:0, marginNew$:0, marginRen$:0 });
      return { items, totals };
    }
    /* =======================
       RENDER
    ======================= */
    function render(){
      const m = model();
      const root = document.getElementById('app');
      root.innerHTML = `
        <header class="pt-8 pb-6 px-6 lg:px-12">
          <div class="mx-auto max-w-6xl flex items-center justify-between">
            <h1 class="text-3xl font-semibold leading-tight">Recast Pricing Calculator</h1>
            <button type="button" class="inline-flex items-center gap-2 bg-[#2563eb] hover:bg-blue-700 text-white rounded-full px-6 py-2 shadow-sm transition-shadow duration-300" data-action="copy">
              <i data-lucide="clipboard" class="w-4 h-4"></i><span>${STATE.copied ? 'Copied!' : 'Copy Email'}</span>
            </button>
          </div>
          <p class="mx-auto max-w-6xl mt-2 max-w-2xl text-base text-gray-700 leading-relaxed">Estimate only. Not a formal quote.</p>
          <div class="mx-auto max-w-6xl mt-6 hidden sm:flex w-full rounded-full bg-gray-100 p-1 gap-1">
            ${tabBtn('customer','Customer Pricing')}
            ${tabBtn('partner','Partner Pricing')}
            ${tabBtn('sla','Support SLA')}
          </div>
          <div class="mx-auto max-w-6xl mt-6 sm:hidden">
            <select class="w-full rounded-full border border-gray-300 bg-white px-4 py-2 text-sm" data-action="switch-mobile">
              <option value="customer" ${STATE.activeTab==='customer'?'selected':''}>Customer Pricing</option>
              <option value="partner" ${STATE.activeTab==='partner'?'selected':''}>Partner Pricing</option>
              <option value="sla" ${STATE.activeTab==='sla'?'selected':''}>Support SLA</option>
            </select>
          </div>
        </header>
        <main class="mx-auto max-w-6xl px-6 lg:px-12 pb-16">
          <section class="grid grid-cols-1 gap-6 lg:grid-cols-3">
            ${inputsCard(m)}
            ${kpiCard('Total ARR (MSRP)', money(m.totals.msrp), 'calculator')}
            ${kpiCard('Base ARR', money(m.totals.baseARR), 'badge-dollar-sign')}
          </section>
          <section class="mt-6">
            ${STATE.activeTab==='customer' ? renderCustomer(m) : ''}
            ${STATE.activeTab==='partner' ? renderPartner(m) : ''}
            ${STATE.activeTab==='sla' ? renderSLA() : ''}
          </section>
        </main>
      `;
      if (window.lucide?.createIcons) { try { window.lucide.createIcons(); } catch {} }
      attachEvents();
      if (STATE.showBreakdown) updateBreakdownTable();
    }
    /* ---------- Sub-renders ---------- */
    function tabBtn(id,label){
      const active = STATE.activeTab===id;
      return `
        <button type="button" class="${cx('flex-1 inline-flex justify-center items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition-all duration-300', active ? 'bg-[#2563eb] text-white shadow-sm' : 'text-gray-700 hover:bg-gray-200')}"
          data-action="switch" data-tab="${id}" aria-controls="panel-${id}" aria-selected="${active}">
          <i data-lucide="${id==='customer'?'calculator':id==='partner'?'users':'life-buoy'}" class="w-4 h-4"></i><span>${label}</span>
        </button>
      `;
    }
    function inputsCard(m){
      return `
        <div class="bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300 lg:col-span-2" role="region" aria-label="Inputs">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-medium">Line Items</h2>
            <button class="inline-flex items-center gap-2 bg-[#2563eb] hover:bg-blue-700 text-white rounded-full px-6 py-2 shadow-sm transition-shadow duration-300 text-sm" data-action="add-item">
              <i data-lucide="plus" class="w-4 h-4"></i>Add Product
            </button>
          </div>
          <div class="mt-6 space-y-4">
            ${STATE.items.map(itemRow).join('')}
          </div>
          <div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-3 text-sm">
            <div class="rounded-lg bg-gray-50 px-4 py-3"><span class="text-gray-500">Total Platform Fees</span><div class="font-semibold text-gray-900 mt-1">${money(m.totals.platform)}</div></div>
            <div class="rounded-lg bg-gray-50 px-4 py-3"><span class="text-gray-500">Total Support</span><div class="font-semibold text-gray-900 mt-1">${money(m.totals.support)}</div></div>
            <div class="rounded-lg bg-gray-50 px-4 py-3"><span class="text-gray-500">Total Quantity</span><div class="font-semibold text-gray-900 mt-1">${m.totals.endpoints.toLocaleString()}</div></div>
          </div>
        </div>
      `;
    }
    function itemRow(item){
      const meta = PRODUCTS[item.productKey] || PRODUCTS.rct;
      const isAW = ['aw_cloud', 'aw_onprem'].includes(item.productKey);
      const isUserMode = isAW && item.pricingModel === 'user';
      const unitLabel = isUserMode ? 'User' : 'Endpoint';
      return `
        <div class="rounded-xl border border-gray-200 bg-white p-4" data-item="${item.id}">
          <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-center">
            <label class="flex flex-col gap-1 text-sm sm:col-span-3">
              <span class="text-gray-500">Product</span>
              <select class="mt-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[#2563eb] focus:ring-[#2563eb]" data-action="change-product" aria-label="Product">
                ${Object.entries(PRODUCTS).map(([k,v])=>`<option value="${k}" ${item.productKey===k?'selected':''}>${v.name}</option>`).join('')}
              </select>
            </label>
            <label class="flex flex-col gap-1 text-sm sm:col-span-3">
              <span class="text-gray-500">${unitLabel} count</span>
              <input class="mt-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[#2563eb] focus:ring-[#2563eb]"
                     type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" spellcheck="false"
                     value="${item.endpointsText}" data-action="edit-endpoints" aria-label="${unitLabel} count">
            </label>
            ${isAW ? `
              <label class="flex flex-col gap-1 text-sm sm:col-span-2">
                <span class="text-gray-500">Pricing Model</span>
                <select class="mt-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[#2563eb] focus:ring-[#2563eb]" data-action="change-model" aria-label="Pricing Model">
                  <option value="endpoint" ${item.pricingModel==='endpoint'?'selected':''}>Per Endpoint</option>
                  <option value="user" ${item.pricingModel==='user'?'selected':''}>Per User</option>
                </select>
              </label>
            ` : ''}
            <label class="flex items-center gap-2 text-sm sm:col-span-2">
              <input type="checkbox" ${item.addSupport?'checked':''} ${isUserMode ? 'disabled' : ''} class="h-4 w-4 rounded border-gray-300 text-[#2563eb] focus:ring-[#2563eb]" data-action="toggle-support" aria-label="Add premium support">
              <span>Premium Support</span>
            </label>
            <div class="sm:col-span-2 flex justify-start sm:justify-end">
              <button class="inline-flex items-center gap-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-full px-4 py-2 shadow-sm transition-shadow duration-300 ${STATE.items.length===1?'opacity-50 cursor-not-allowed':''}" data-action="remove-item" ${STATE.items.length===1?'disabled aria-disabled="true"':''}>
                <i data-lucide="trash-2" class="w-4 h-4"></i><span>Remove</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }
    function kpiCard(label,value,icon){
      return `
        <div class="bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300" role="region" aria-live="polite">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">${label}</div>
              <div class="text-2xl font-semibold font-mono mt-1">${value}</div>
            </div>
            <i data-lucide="${icon}" class="w-6 h-6 text-[#2563eb]" aria-hidden="true"></i>
          </div>
        </div>
      `;
    }
    function renderCustomer(m){
      return `
        <section id="panel-customer" role="tabpanel" aria-labelledby="tab-customer" class="space-y-6">
          <div class="bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-xl font-medium">Customer Quote</h3>
            <div class="mt-4 overflow-x-auto rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 text-gray-500">
                  <tr>
                    <th class="px-4 py-3 text-left font-medium">Product</th>
                    <th class="px-4 py-3 text-left font-medium">Quantity</th>
                    <th class="px-4 py-3 text-left font-medium">Base ARR</th>
                    <th class="px-4 py-3 text-left font-medium">Platform Fee</th>
                    <th class="px-4 py-3 text-left font-medium">Premium Support</th>
                    <th class="px-4 py-3 text-left font-medium">Line Total (MSRP)</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${m.items.map(it => `
                    <tr>
                      <td class="px-4 py-3 text-gray-900">${it.productName}</td>
                      <td class="px-4 py-3 text-gray-900">${it.endpoints.toLocaleString()}</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.baseARR)}</td>
                      <td class="px-4 py-3 text-gray-900">${it.platformWaived ? '— (waived)' : `<span class="font-mono">${money(it.platformFeeApplied)}</span>`}</td>
                      <td class="px-4 py-3 text-gray-900">${it.addSupport ? `<span class="font-mono">${money(it.support)}</span>` : '—'}</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.totalARR)}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-right font-medium" colspan="2">Totals</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.baseARR)}</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.platform)}</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.support)}</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.msrp)}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <button type="button" class="mt-4 inline-flex items-center gap-2 text-sm bg-[#2563eb] hover:bg-blue-700 text-white rounded-full px-4 py-2 shadow-sm transition-shadow duration-300" data-action="toggle-breakdown" aria-expanded="${STATE.showBreakdown}">
              <i data-lucide="${STATE.showBreakdown?'chevron-up':'chevron-down'}" class="w-4 h-4"></i>
              ${STATE.showBreakdown ? 'Hide tier calculation' : 'Show tier calculation'}
            </button>
            <div id="breakdown" class="${STATE.showBreakdown ? 'mt-4 space-y-4' : 'hidden'}">
              ${m.items.map(it => tierTable(it)).join('')}
            </div>
          </div>
        </section>
      `;
    }
    function tierTable(it){
      return `
        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <caption class="text-left px-4 py-3 bg-gray-50 font-medium text-gray-900">${it.productName} — ${it.endpoints.toLocaleString()} ${it.isUserMode ? 'users' : 'endpoints'}</caption>
            <thead class="bg-gray-50 text-gray-500">
              <tr><th class="px-4 py-3 text-left font-medium">Band</th><th class="px-4 py-3 text-left font-medium">Units</th><th class="px-4 py-3 text-left font-medium">$ / Unit</th><th class="px-4 py-3 text-left font-medium">Extended</th></tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${it.lines.map(r=>`
                <tr>
                  <td class="px-4 py-3 text-gray-900">${r.band}</td>
                  <td class="px-4 py-3 text-gray-900">${r.units.toLocaleString()}</td>
                  <td class="px-4 py-3 font-mono text-gray-900">${money(r.rate)}</td>
                  <td class="px-4 py-3 font-mono text-gray-900">${money(r.extended)}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot class="bg-gray-50">
              <tr><th class="px-4 py-3 text-right font-medium" colspan="3">Base ARR Subtotal</th><th class="px-4 py-3 text-left font-mono text-gray-900">${money(it.baseARR)}</th></tr>
            </tfoot>
          </table>
        </div>
      `;
    }
    function renderPartner(m){
      return `
        <section id="panel-partner" role="tabpanel" aria-labelledby="tab-partner" class="space-y-6">
          <div class="bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-xl font-medium">Partner Quote (Per Line Item)</h3>
            <div class="mt-4 overflow-x-auto rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 text-gray-500">
                  <tr>
                    <th class="px-4 py-3 text-left font-medium">Product</th>
                    <th class="px-4 py-3 text-left font-medium">Quantity</th>
                    <th class="px-4 py-3 text-left font-medium">MSRP (List)</th>
                    <th class="px-4 py-3 text-left font-medium">Net New Margin %</th>
                    <th class="px-4 py-3 text-left font-medium">Net New Margin $</th>
                    <th class="px-4 py-3 text-left font-medium">Net New Partner Price</th>
                    <th class="px-4 py-3 text-left font-medium">Renewal Margin %</th>
                    <th class="px-4 py-3 text-left font-medium">Renewal Margin $</th>
                    <th class="px-4 py-3 text-left font-medium">Renewal Partner Price</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${m.items.map(it => `
                    <tr>
                      <td class="px-4 py-3 text-gray-900">${it.productName}</td>
                      <td class="px-4 py-3 text-gray-900">${it.endpoints.toLocaleString()}</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.msrp)}</td>
                      <td class="px-4 py-3 text-gray-900">25%</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.marginNew$)}</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.partnerNewPrice)}</td>
                      <td class="px-4 py-3 text-gray-900">15%</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.marginRen$)}</td>
                      <td class="px-4 py-3 font-mono text-gray-900">${money(it.partnerRenPrice)}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-right font-medium" colspan="2">Totals</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.msrp)}</th>
                    <th class="px-4 py-3 text-left text-gray-900">—</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.marginNew$)}</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.partnerNew)}</th>
                    <th class="px-4 py-3 text-left text-gray-900">—</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.marginRen$)}</th>
                    <th class="px-4 py-3 text-left font-mono text-gray-900">${money(m.totals.partnerRen)}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <p class="mt-2 text-sm text-gray-500">MSRP includes platform fee (if not waived) and premium support (if selected) per line item. Partner prices reflect margins applied to each line.</p>
          </div>
        </section>
      `;
    }
    function renderSLA(){
      return `
        <section id="panel-sla" role="tabpanel" aria-labelledby="tab-sla" class="space-y-6">
          <div class="bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-xl font-medium">Support SLA</h3>
            <div class="mt-4 overflow-x-auto rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 text-gray-500">
                  <tr><th class="px-4 py-3 text-left font-medium">Support Level</th><th class="px-4 py-3 text-left font-medium">Basic</th><th class="px-4 py-3 text-left font-medium">Premium</th></tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr><td class="px-4 py-3 text-gray-900">Urgent Severity</td><td class="px-4 py-3 text-gray-900">First response: <strong>1 Business Day</strong></td><td class="px-4 py-3 text-gray-900">First & update: <strong>2 Business Hours</strong></td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Normal Severity</td><td class="px-4 py-3 text-gray-900">First response: <strong>2 Business Days</strong></td><td class="px-4 py-3 text-gray-900">First & update: <strong>4 Business Hours</strong></td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Low Severity</td><td class="px-4 py-3 text-gray-900">First response: <strong>3 Business Days</strong></td><td class="px-4 py-3 text-gray-900">First & update: <strong>8 Business Hours</strong></td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Availability</td><td class="px-4 py-3 text-gray-900" colspan="2">8am – 5pm CT/CET</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Support Hours</td><td class="px-4 py-3 text-gray-900" colspan="2">Unlimited</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Dedicated CSM</td><td class="px-4 py-3 text-gray-900">✔</td><td class="px-4 py-3 text-gray-900">✔</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Support Call Scheduling</td><td class="px-4 py-3 text-gray-900">Based on availability</td><td class="px-4 py-3 text-gray-900">Urgent within 2 business days; Normal within 4; Low based on availability</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Environment Audit</td><td class="px-4 py-3 text-gray-900">—</td><td class="px-4 py-3 text-gray-900">1× / year</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Configuration Audit</td><td class="px-4 py-3 text-gray-900">—</td><td class="px-4 py-3 text-gray-900">1× / year</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Upgrade Assistance</td><td class="px-4 py-3 text-gray-900">—</td><td class="px-4 py-3 text-gray-900">2× / year</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">User Group Membership</td><td class="px-4 py-3 text-gray-900">Based on availability</td><td class="px-4 py-3 text-gray-900">Priority recruitment</td></tr>
                  <tr><td class="px-4 py-3 text-gray-900">Pricing</td><td class="px-4 py-3 text-gray-900">Included with Enterprise License</td><td class="px-4 py-3 text-gray-900">+20% of total ARR (minimum $6,000)</td></tr>
                </tbody>
              </table>
            </div>
            <p class="mt-2 text-sm text-gray-500">Note: Response-time commitments do not guarantee time to resolution.</p>
          </div>
        </section>
      `;
    }
    /* =======================
       EMAIL COPY (multi-item)
    ======================= */
    function buildEmailText(m, clientName){
      const name = clientName && clientName.trim() ? clientName.trim() : '[Client Name]';
      const subject = `Subject: Pricing Estimate for ${m.items.length>1?'Multiple Products':m.items[0]?.productName || 'Products'}`;
      const lines = [
        subject,
        `Hi ${name},`,
        '',
        'As requested, here is a high-level pricing estimate based on your requirements:',
      ];
      m.items.forEach((it, idx) => {
        lines.push(
          `Product ${idx+1}: ${it.productName}`,
          `Quantity: ${it.endpoints.toLocaleString()}`,
          `Platform Fee: ${it.platformWaived ? '— (waived)' : money(it.platformFeeApplied)}`,
          `Premium Support: ${it.addSupport ? money(it.support) : '—'}`,
          `Base Total ARR (graduated): ${money(it.baseARR)}`,
          `Line Total (MSRP): ${money(it.msrp)}`,
          ''
        );
      });
      lines.push(
        'Order Totals:',
        `Base ARR: ${money(m.totals.baseARR)}`,
        `Platform Fees: ${money(m.totals.platform)}`,
        `Premium Support: ${money(m.totals.support)}`,
        `Total ARR (MSRP): ${money(m.totals.msrp)}`,
        '',
        'Below is a breakdown of pricing with MSRP, partner margin, and partner price:',
        '| Type | MSRP (List) | Margin % | Margin $ | Partner Price |',
        '|------------|-------------|----------|-----------|---------------|',
        `| Net New | ${money(m.totals.msrp)} | 25% | ${money(m.totals.marginNew$)}| ${money(m.totals.partnerNew)} |`,
        `| Renewal | ${money(m.totals.msrp)} | 15% | ${money(m.totals.marginRen$)}| ${money(m.totals.partnerRen)} |`,
        `| **Total** | ${money(m.totals.msrp)} | – | – | – |`,
        '',
        'Please note this is an estimate only and should not be considered a formal quote.',
        'Let me know if you’d like me to prepare a formal proposal or discuss package options.',
        'Best regards,',
        'Recast Partner Team'
      );
      return lines.join('\n');
    }
    /* =======================
       EVENTS
    ======================= */
    function attachEvents(){
      const root = document.getElementById('app');
      // Add item
      const addBtn = root.querySelector('[data-action="add-item"]');
      if(addBtn){
        addBtn.addEventListener('click', () => {
          STATE.items.push({ id: cryptoRandomId(), productKey: 'rct', endpointsText: '0', addSupport: false, pricingModel: 'endpoint' });
          render();
        });
      }
      // Delegate events per item
      root.querySelectorAll('[data-item]').forEach(container => {
        const id = container.getAttribute('data-item');
        const item = STATE.items.find(x=>x.id===id);
        if(!item) return;
        const isAW = ['aw_cloud', 'aw_onprem'].includes(item.productKey);
        const isUserMode = isAW && item.pricingModel === 'user';
        // Product change
        const sel = container.querySelector('[data-action="change-product"]');
        if(sel) sel.addEventListener('change', e => { item.productKey = e.target.value; if (!['aw_cloud', 'aw_onprem'].includes(e.target.value)) item.pricingModel = 'endpoint'; render(); });
        // Model change
        const modelSel = container.querySelector('[data-action="change-model"]');
        if(modelSel) modelSel.addEventListener('change', e => {
          item.pricingModel = e.target.value;
          if (item.pricingModel === 'user') {
            item.addSupport = false;
            const currentUnits = int(item.endpointsText);
            if (currentUnits < 250) item.endpointsText = '250';
          }
          render();
        });
        // Support toggle
        const sup = container.querySelector('[data-action="toggle-support"]');
        if(sup) sup.addEventListener('change', e => { if (!isUserMode) item.addSupport = !!e.target.checked; render(); });
        // Endpoints input
        const ep = container.querySelector('[data-action="edit-endpoints"]');
        if(ep){
          ep.addEventListener('beforeinput', e => { if(e.data && /\D/.test(e.data)) e.preventDefault(); });
          ep.addEventListener('input', e => {
            item.endpointsText = digitsOnly(e.target.value);
            const caret = item.endpointsText.length;
            render();
            const repl = document.querySelector(`[data-item="${id}"] [data-action="edit-endpoints"]`);
            if(repl){ repl.focus(); repl.setSelectionRange(caret, caret); }
          });
          ep.addEventListener('blur', e => {
            let units = int(item.endpointsText);
            if (isUserMode) units = Math.max(250, units);
            item.endpointsText = String(units);
            render();
          });
          ep.addEventListener('keydown', e => { if(e.key==='Enter'){ e.currentTarget.blur(); } });
          ep.addEventListener('wheel', e => { e.preventDefault(); }, { passive: false });
        }
        // Remove item
        const rm = container.querySelector('[data-action="remove-item"]');
        if(rm) rm.addEventListener('click', () => {
          if(STATE.items.length<=1) return;
          STATE.items = STATE.items.filter(x=>x.id!==id);
          render();
        });
      });
      // Tab switching
      root.querySelectorAll('[data-action="switch"]').forEach(b => b.addEventListener('click', e => {
        STATE.activeTab = e.currentTarget.getAttribute('data-tab');
        render();
      }));
      // Mobile tab switch
      const mobileSel = root.querySelector('[data-action="switch-mobile"]');
      if(mobileSel) mobileSel.addEventListener('change', e => { STATE.activeTab = e.target.value; render(); });
      // Copy email
      const copyBtn = root.querySelector('[data-action="copy"]');
      if(copyBtn) copyBtn.addEventListener('click', async () => {
        const m = model();
        let clientName = '';
        try { clientName = window.prompt('Client name for the email? (optional)', '') || ''; } catch {}
        const text = buildEmailText(m, clientName);
        try { await navigator.clipboard.writeText(text); }
        catch {
          try {
            const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
            document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          } catch {}
        }
        STATE.copied = true; render(); setTimeout(()=>{ STATE.copied = false; render(); }, 1200);
      });
      // Show/Hide tier breakdown
      const toggle = root.querySelector('[data-action="toggle-breakdown"]');
      if(toggle) toggle.addEventListener('click', () => { STATE.showBreakdown = !STATE.showBreakdown; render(); });
    }
    function updateBreakdownTable(){ /* populated during render via tierTable per item */ }
    /* =======================
       INIT
    ======================= */
    document.addEventListener('DOMContentLoaded', () => {
      render();
      if(!window.tailwind){
        const b=document.createElement('div'); b.role='alert'; b.className='mx-auto max-w-6xl px-6 lg:px-12 mt-3';
        b.innerHTML='<div class="rounded-lg bg-amber-500/10 border border-amber-400/30 text-amber-900 px-4 py-3 text-sm">Styles failed to load. The calculator still works, but appearance may differ.</div>';
        document.body.prepend(b);
      }
    });
  </script>
</body>
</html>
